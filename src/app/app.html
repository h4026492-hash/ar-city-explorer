<!-- Main Home View -->
@if (!showLandmarkList() && !showCitySelection()) {
<div class="app-container">
  <!-- Demo Mode Banner -->
  @if (isDemoMode()) {
    <div class="demo-mode-banner" (click)="exitDemoMode()">
      <span class="demo-icon">ğŸ¬</span>
      <span class="demo-text">INVESTOR DEMO MODE</span>
      <span class="demo-exit">Tap to exit</span>
    </div>
  }
  
  <!-- App Header (with secret trigger for demo) -->
  <div class="header" (click)="onHeaderTap()">
    <h1>AR City Explorer</h1>
    <p class="subtitle">Point your camera to discover {{ activeCity()?.name || 'Dallas' }}</p>
  </div>
  
  <!-- City Switcher -->
  <button class="city-switcher" (click)="openCitySelection()">
    <span class="city-icon">ğŸ“</span>
    <span class="city-name">{{ activeCity()?.name || 'Dallas' }}</span>
    <span class="change-label">Change</span>
  </button>
  
  <!-- Streak Badge -->
  @if (streak() > 0) {
    <div class="streak-badge">
      ğŸ”¥ {{ streak() }} day streak!
    </div>
  }
  
  <!-- Landmark of the Day - FREE for all users -->
  @if (landmarkOfTheDay()) {
    <div class="lotd-card" (click)="exploreLandmarkOfTheDay()">
      <div class="lotd-header">
        <span class="lotd-label">ğŸ›ï¸ Landmark of the Day</span>
        <span class="lotd-free-badge">FREE</span>
      </div>
      <span class="lotd-name">{{ landmarkOfTheDay()!.name }}</span>
      <button class="lotd-cta-button">Explore Now â†’</button>
    </div>
  }
  
  <!-- Primary Action Buttons -->
  <div class="primary-buttons">
    <button class="ar-button primary" (click)="openAR()">
      <span class="button-icon">ğŸ“±</span>
      Explore in AR
    </button>
    
    <button class="browse-button secondary" (click)="openLandmarkList()">
      <span class="button-icon">ğŸ“‹</span>
      Browse Landmarks
    </button>
  </div>
  
  <!-- Walking Tours Button -->
  <button class="tours-button" (click)="openTourList()">
    <span class="tours-icon">ğŸ—ºï¸</span>
    <span class="tours-text">Walking Tours</span>
    <span class="tours-badge">New</span>
  </button>
  
  <!-- Walk Mode Button -->
  <button 
    class="walk-button" 
    [class.active]="isWalkModeActive()"
    (click)="toggleWalkMode()">
    @if (isWalkModeActive()) {
      <span class="walk-icon">ğŸš¶</span>
      Stop Walk
    } @else {
      <span class="walk-icon">ğŸ‘Ÿ</span>
      Start Walk
    }
  </button>
  
  <!-- Walk Mode Status -->
  @if (isWalkModeActive()) {
    <div class="walk-status" [class.paused]="isWalkModePaused()">
      @if (gpsAccuracyPoor()) {
        <span class="status-icon">ğŸ“¡</span>
        <span>Waiting for better GPS signal...</span>
      } @else if (isWalkModePaused()) {
        <span class="status-icon">â¸ï¸</span>
        <span>Walk paused</span>
      } @else {
        <span class="status-icon">ğŸ“</span>
        <span>Walking mode active â€“ exploring Dallas!</span>
      }
    </div>
  }
  
  <!-- Usage Counter (Free Users) -->
  @if (!isPremium()) {
    <div class="usage-counter">
      <span class="usage-label">Free taps today:</span>
      <div class="usage-dots">
        @for (i of [1, 2, 3]; track i) {
          <span class="usage-dot" [class.used]="todayTaps() >= i"></span>
        }
      </div>
      <span class="usage-remaining">{{ remainingTaps() }} remaining</span>
    </div>
  }
  
  <!-- Premium Section -->
  <div class="premium-section">
    <div class="premium-badge" [class.active]="isPremium()">
      {{ isPremium() ? 'â­ Premium' : 'Free Plan' }}
    </div>
    
    @if (isPremium()) {
      <!-- City Pack Status -->
      @if (cityPackStatus()) {
        <div class="pack-status">
          @if (cityPackStatus()!.isDownloaded) {
            <span class="pack-version">ğŸ“¦ Dallas pack v{{ cityPackStatus()!.localVersion }}</span>
            @if (cityPackStatus()!.isOutdated) {
              <span class="pack-update-badge">Update available</span>
            }
          } @else {
            <span class="pack-not-downloaded">ğŸ“¦ Offline pack not downloaded</span>
          }
        </div>
      }
      
      <p class="offline-count">{{ downloadedCount() }} landmarks saved offline</p>
      
      <!-- Download Progress -->
      @if (isPackDownloading()) {
        <div class="download-progress">
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="packDownloadProgress()"></div>
          </div>
          <span class="progress-text">{{ packDownloadProgress() }}%</span>
        </div>
      } @else {
        <button 
          class="download-button" 
          (click)="downloadDallasPack()">
          @if (cityPackStatus()?.isDownloaded) {
            Update Dallas Pack
          } @else {
            Download Dallas Pack
          }
        </button>
      }
      
      <!-- Memory Management (Premium Only) -->
      @if (getMemoryCount() > 0) {
        <div class="memory-status">
          <span class="memory-icon">ğŸ§ </span>
          <span class="memory-count">{{ getMemoryCount() }} landmarks remembered</span>
          <button class="clear-memory-btn" (click)="confirmClearMemory()">
            Clear
          </button>
        </div>
      }
    } @else {
      <button class="upgrade-button" (click)="openPaywall()">
        Upgrade to Premium
      </button>
    }
    
    <!-- Dev Toggle -->
    <button class="toggle-button" (click)="togglePremium()">
      {{ isPremium() ? 'Switch to Free' : 'Try Premium' }}
    </button>
    
    <!-- Analytics Debug (Dev Only) -->
    <button class="toggle-button debug" (click)="showAnalyticsDebug.set(true)">
      ğŸ“Š Analytics Debug
    </button>
  </div>
  
  <!-- Analytics Transparency Section -->
  <div class="analytics-disclosure">
    <div class="disclosure-header">
      <span class="disclosure-icon">ğŸ”’</span>
      <span class="disclosure-title">Privacy</span>
    </div>
    <p class="disclosure-text">
      This app collects anonymous usage statistics to improve features. 
      No personal data is collected.
    </p>
    <div class="analytics-toggle">
      <span class="toggle-label">Anonymous Analytics</span>
      <button 
        class="toggle-switch" 
        [class.enabled]="isAnalyticsEnabled()"
        (click)="toggleAnalytics()">
        <span class="toggle-knob"></span>
      </button>
    </div>
  </div>
</div>
}

<!-- Clear Memory Confirmation -->
@if (showClearMemoryConfirm()) {
  <div class="update-prompt-overlay" (click)="dismissClearMemory()"></div>
  <div class="update-prompt">
    <div class="prompt-icon">ğŸ§ </div>
    <h3>Clear AI Memory?</h3>
    <p>This will reset your learning history. AI will no longer remember what you've already explored and may repeat previous explanations.</p>
    <div class="prompt-actions">
      <button class="prompt-btn danger" (click)="clearAllMemory()">
        Clear Memory
      </button>
      <button class="prompt-btn secondary" (click)="dismissClearMemory()">
        Cancel
      </button>
    </div>
  </div>
}

<!-- Pack Update Prompt -->
@if (showPackUpdatePrompt()) {
  <div class="update-prompt-overlay" (click)="dismissPackUpdate()"></div>
  <div class="update-prompt">
    <div class="prompt-icon">ğŸ“¦</div>
    <h3>Update Available</h3>
    <p>A new version of the Dallas pack is available with improved content.</p>
    <div class="prompt-actions">
      <button class="prompt-btn primary" (click)="updateDallasPack()">
        Update Now
      </button>
      <button class="prompt-btn secondary" (click)="dismissPackUpdate()">
        Later
      </button>
    </div>
  </div>
}

<!-- Landmark List View -->
@if (showLandmarkList()) {
  <app-landmark-list
    (back)="closeLandmarkList()"
    (openAR)="openARFromList($event)"
    (showPaywall)="openPaywall()">
  </app-landmark-list>
}

<!-- City Selection View -->
@if (showCitySelection()) {
  <app-city-selection
    (back)="closeCitySelection()"
    (citySelected)="onCitySelected($event)"
    (showPaywall)="openPaywall()">
  </app-city-selection>
}

<!-- Tour List View -->
@if (showTourList()) {
  <app-tour-list
    (back)="closeTourList()"
    (selectTourEvent)="onTourSelected($event)">
  </app-tour-list>
}

<!-- Tour Detail View -->
@if (showTourDetail() && selectedTour()) {
  <app-tour-detail
    [tour]="selectedTour()"
    (back)="closeTourDetail()"
    (showPaywall)="showTourPaywall()"
    (startTourEvent)="onStartTour()">
  </app-tour-detail>
}

<!-- Bottom Sheet for AI Explanations -->
@if (showSheet()) {
  <div class="sheet-overlay" (click)="closeSheet()"></div>
  
  <div class="bottom-sheet">
    <!-- Handle -->
    <div class="sheet-handle"></div>
    
    <!-- Close Button -->
    <button class="close-button" (click)="closeSheet()">âœ•</button>
    
    @if (isLoading()) {
      <!-- Loading Skeleton -->
      <div class="skeleton-container">
        <div class="skeleton skeleton-title"></div>
        <div class="skeleton skeleton-line"></div>
        <div class="skeleton skeleton-line short"></div>
        <div class="skeleton skeleton-line shorter"></div>
      </div>
    } @else if (currentExplanation()) {
      <div class="explanation">
        <div class="explanation-header">
          <h2>{{ currentExplanation()?.name }}</h2>
          <div class="explanation-meta">
            @if (currentExplanation()?.distance) {
              <span class="distance-badge">{{ formatDistance(currentExplanation()?.distance) }}</span>
            }
            @if (currentExplanation()?.bearing !== undefined) {
              <svg class="bearing-arrow" viewBox="0 0 24 24" width="18" height="18" style="transform: rotate({{ currentExplanation()?.bearing }}deg); transition: transform 0.3s ease;">
                <path d="M12 2 L19 21 L12 17 L5 21 Z" fill="#fff" />
              </svg>
            }
            @if (isOffline()) {
              <span class="offline-badge">ğŸ“± Offline</span>
            }
          </div>
        </div>
        
        <!-- Interest Badge -->
        @if (matchedInterest()) {
          <div class="interest-badge">
            âœ¨ Because you like {{ matchedInterest() }}
          </div>
        }
        
        <!-- Previously Visited Badge -->
        @if (visitedBefore()) {
          <div class="visited-badge">
            ğŸ”„ {{ visitedBefore() }} â€¢ Here's what's new
          </div>
        }
        
        <p class="explanation-text">{{ currentExplanation()?.text }}</p>
        
        <!-- Action Buttons -->
        <div class="sheet-actions">
          <button class="action-button share" (click)="shareLandmark()">
            <span class="action-icon">ğŸ“¤</span>
            Share
          </button>
          @if (!isPremium()) {
            <button class="action-button premium" (click)="openPaywall()">
              <span class="action-icon">â­</span>
              Save Offline
            </button>
          }
        </div>
      </div>
    }
  </div>
}

<!-- Paywall -->
@if (showPaywall()) {
  <app-paywall 
    [tourContext]="tourPaywallContext() ?? undefined"
    (dismissed)="closePaywall()" 
    (subscribed)="onSubscribed($event)">
  </app-paywall>
}

<!-- Walk Mode: Next Landmark Prompt -->
@if (pendingLandmark()) {
  <app-next-landmark-prompt
    [landmarkName]="pendingLandmark()!.name"
    [distance]="pendingLandmarkDistance()"
    (explore)="onExplorePending()"
    (skip)="onSkipPending()">
  </app-next-landmark-prompt>
}

<!-- Onboarding -->
@if (showOnboarding()) {
  <app-onboarding (complete)="onOnboardingComplete()"></app-onboarding>
}

<!-- Analytics Debug (Dev Only) -->
@if (showAnalyticsDebug()) {
  <app-analytics-debug (close)="showAnalyticsDebug.set(false)"></app-analytics-debug>
}

<router-outlet />
